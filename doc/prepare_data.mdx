# prepare_data.py 処理概要

## 概要
`prepare_data.py`は衛星画像データを深層学習用に前処理するスクリプトです。
主に航空雲（contrails）検出タスクのために、多スペクトル衛星画像データを偽色画像に変換し、トレーニング用とバリデーション用のデータセットを生成します。

## 主要機能

### 1. データ読み込み (`read_record`)
- 指定されたパスから以下のファイルを読み込み
  - `band_11.npy`: 赤外線チャンネル11
  - `band_14.npy`: 赤外線チャンネル14  
  - `band_15.npy`: 赤外線チャンネル15
  - `human_pixel_masks.npy`: 人間によるアノテーション

### 2. 偽色画像生成 (`get_false_color`)
3つの赤外線チャンネルから偽色画像を生成：
- **R (赤)**: band_15 - band_14の差分（範囲: -4～2）
- **G (緑)**: band_14 - band_11の差分（範囲: -4～5）  
- **B (青)**: band_14の絶対値（範囲: 243～303K）

各チャンネルは正規化され[0,1]の範囲にマッピングされます。

### 3. データ変換モード

#### マルチフレーム処理 (`multiframe`)
- 全時刻（8フレーム）のデータを1つのファイルに統合
- 出力形状: (256, 256, 24) = (高さ, 幅, 3チャンネル×8時刻)
- トレーニング用: `train_adj2/`
- バリデーション用: `val_adj2/`

#### シングルフレーム処理 (`singleframe`)  
- 特定時刻（4番目のフレーム）のみを抽出
- 出力形状: (256, 256, 3)
- トレーニング用: `train_adj2single/`
- バリデーション用: `val_adj2single/`

### 4. マスク処理
- **トレーニング**: 全時刻のマスクの平均値を使用
- **バリデーション**: 元のマスクをそのまま使用

## 出力ファイル
各データポイントに対して2つのファイルを生成：
- `{record_id}_img.tif`: 偽色画像（TIFF形式、0-255の8bit整数）
- `{record_id}_mask.tif`: アノテーションマスク（TIFF形式、0-255の8bit整数）

## 実行方法
```bash
python prepare_data.py config.json
```

設定ファイル（`config.json`）から`PATH`パラメータを読み取り、データディレクトリを指定します。

## 技術的詳細
- 正規化範囲は経験的に決定された値を使用
- 衛星データの物理的特性を考慮した偽色合成
- メモリ効率を考慮したバッチ処理
- TIFF形式での高品質画像保存